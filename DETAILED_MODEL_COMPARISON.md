# 詳細なモデル比較: naive_simulation vs symbolic_analysis (N_i=1)

## 問題の整理

### 観察された現象
- `E[d_04] > E[d_06]` が成立するパラメータが：
  - **naive_simulation**: 存在する
  - **symbolic_analysis**: 存在しない

### 重要な洞察
- もし単純なスカラー倍（距離が2倍）の違いなら、不等号の向きは保たれるはず
- したがって、**より本質的な違い**が存在する

## モデル実装の比較結果

### ✅ 一致している要素

#### 1. ネットワーク行列 W

**bidirectional_flow** (`m` パラメータ):
- 両モデルとも端点: `W[i,i] = 1 - m/2`、内部: `W[i,i] = 1 - m`
- 隣接: `W[i, i±1] = m/2`

**outward_flow** (`m` パラメータ):
- 両モデルとも中心: `W[c,c] = 1`
- 非中心: `W[i,i] = 1 - m`
- 中心からの流れ: 中心より左のiは右隣から、右のiは左隣からコピー

#### 2. 突然変異モデル
- 両方とも **parent-side mutation** を実装
- コピー元エージェント `j` の突然変異率 `μ_j` で判定
- `μ_j = α_j / (1 + α_j)` (N_i=1の場合)

#### 3. 状態更新プロセス
- 両方とも1タイムステップで**全エージェントが同時に更新**
- 各エージェントは独立に新しいデータをサンプリング

#### 4. コピー確率の計算
- `prob_copy_block(i, C, W, μ) = Σ_{j∈C} W[i,j] × (1 - μ_j)`
- naive_simulationの`multinomial(n=1, pvals=W[i])`と等価

## ⚠️ 潜在的な違いの可能性

### 1. 距離の定義における本質的な違い

**naive_simulation**:
```python
state[i, 0] = [timestep, agent_id, data_index]
counters[i] = {(t, a, b): 1}
```

**重要な点**: データは `(timestep, agent_id, data_index)` の3つ組で識別される

**distance計算**:
- 同じデータ: `dist = 0`
- 異なるデータ: `dist = 2` (マンハッタン距離)

**symbolic_analysis**:
- 同じブロック: `d = 0`
- 異なるブロック: `d = 1`

### 2. 状態空間の定義の違い？

**naive_simulation**:
- 状態 = 各エージェントが持つデータの具体的な値 `[t, a, b]`
- データには「誕生時刻」`t` と「誕生場所」`a` の情報が含まれる
- 2つのエージェントが「同じデータ」 ⇔ `[t, a, b]` が完全一致

**symbolic_analysis**:
- 状態 = エージェントの分割（partition）
- 「同じブロック」= 「同じデータを持つ」
- **データの具体的な値は追跡しない**

### 3. 可能な不一致の原因

#### 仮説A: 「同じデータ」の定義が微妙に違う

naive_simulationでは、2つの異なる時刻に同じエージェントから独立に生成された突然変異は**異なるデータ**:
- 時刻t1でエージェントiが突然変異 → `[t1, i, 0]`
- 時刻t2でエージェントiが突然変異 → `[t2, i, 0]`
- これらは異なるデータ（`t1 ≠ t2`）

symbolic_analysisでは、突然変異は常に**新しいユニークなデータ**を生成するが、具体的なタイムスタンプは保持しない。

**問題**: この違いがdistanceの期待値に影響するか？

#### 仮説B: 遷移確率の解釈が違う

**重要な質問**: symbolic_analysisの`transition_probability(S, S')`は何を表しているのか？

1. **解釈1**: 1タイムステップで状態Sから状態S'へ遷移する確率
   - この場合、naive_simulationと一致するはず

2. **解釈2**: 何か別の確率論的プロセス
   - もし違う解釈なら、定常分布が異なる可能性

#### 仮説C: 初期状態と収束の問題

**naive_simulation**の初期状態:
```python
state[i, 0] = [0, i, 0]  # 各エージェントが異なるデータ
```

**問題点**:
- N_i=1の場合、シミュレーションは定常分布に収束しているか？
- 収束判定は行われているか？
- どのくらいの時間ステップでサンプリングしているか？

### 4. 距離の時間平均の取り方

**naive_simulation**:
```python
# save_interval_min から save_interval_max の間隔で保存
# これらのスナップショットの平均を取る
```

**問題**:
- サンプリング間隔がランダム
- サンプル数が十分か？
- 定常状態に達した後のサンプルのみを使用しているか？

**symbolic_analysis**:
```python
# 定常分布 π を計算
# E[d_ij] = Σ_s π_s × d_ij(s)
```

これは理論的に正しい期待値だが、naive_simulationが同じ定常分布に収束している保証は？

## 🔍 検証すべき点

### 優先度高

1. **定常分布への収束確認**
   - naive_simulationが十分長い時間実行されているか？
   - 距離の時系列プロットで収束を確認
   - 異なる初期状態から同じ分布に収束するか確認

2. **サンプリング方法の確認**
   - バーンイン期間を設定しているか？
   - 自己相関を考慮したサンプリング間隔か？

3. **距離計算の詳細な検証**
   - N_i=1で具体的な状態例を作成
   - 両方の方法で距離を計算して比較
   - マンハッタン距離が本当に常に{0, 2}なのか確認

### 優先度中

4. **状態空間のサイズ確認**
   - M=15の場合、状態数（Bell数）は非常に大きい
   - symbolic_analysisは全状態を列挙できているか？
   - もし近似を使っているなら、それが原因かも

5. **遷移行列の検証**
   - 小さなM（例：M=3）で両方の方法を比較
   - 遷移確率が本当に一致するか数値確認

6. **端点の扱い**
   - エージェント0とM-1の特別な扱いが一致しているか
   - 特にoutward_flowの場合

## 📋 推奨される次のステップ

### Step 1: 簡単な検証
M=3, N_i=1で以下を実行：
```bash
# symbolic_analysisで期待値を計算
python symbolic_analysis/src/analyze_distances.py 3 case1

# naive_simulationを十分長く実行（例：max_t=10000000）
python src/naive_simulation.py --agents_count=3 --N_i=1 --max_t=10000000

# 距離の時系列をプロット
# 定常状態を確認
```

### Step 2: 詳細な比較スクリプト作成
- 同じパラメータ（M, m, alpha）で両方を実行
- 全ペアの距離期待値を比較
- 不一致の原因を特定

### Step 3: 距離定義の統一
もし距離が2倍になるだけなら:
```python
def calc_agent_distance_normalized(state):
    """N_i=1用: 0/1距離"""
    agents_count, N_i, _ = state.shape
    assert N_i == 1
    dist = np.zeros((agents_count, agents_count), dtype=int)
    for i in range(agents_count):
        for j in range(i+1, agents_count):
            if np.array_equal(state[i, 0], state[j, 0]):
                dist[i, j] = dist[j, i] = 0
            else:
                dist[i, j] = dist[j, i] = 1
    return dist
```

## 🚨 最も疑わしい原因

ユーザーの報告「E[d_04] > E[d_06]の不等号が逆転」を考慮すると：

**最も可能性が高い原因**:
1. **シミュレーションが定常状態に達していない**
   - 初期状態の影響が残っている
   - 特にM=15は状態空間が巨大なので収束が遅い可能性

2. **状態空間の定義が微妙に違う**
   - データの「同一性」の判定基準が違う可能性
   - timestampの扱いが影響している可能性

3. **計算精度やバグ**
   - symbolic_analysisの定常分布計算にバグ？
   - naive_simulationの距離計算にバグ？

## 次に確認すべきこと

1. 実際のシミュレーションパラメータは？
   - M=15, m=?, alpha=?, max_t=?, N_i=1 を確認

2. 実際の数値結果は？
   - E_sim[d_04] = ?
   - E_sim[d_06] = ?
   - E_sym[d_04] = ?
   - E_sym[d_06] = ?

3. 距離の時系列プロットはあるか？
   - 収束を視覚的に確認

これらの情報があれば、より具体的な診断が可能です。
